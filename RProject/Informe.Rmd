---
title: "Informe Suicidios"
author: "Ana Blanes Martinez - Xavier Castilla Carbonell"
date: "26/5/2019"
output: 
  html_document:
    toc: true
    toc_depth: 4
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Detalles de la actividad
### 1.1 Descipción
En esta actividad se elabora un caso práctico, consistente en el tratamiento de un conjunto de datos (en inglés, dataset), orientado a aprender a identiﬁcar los datos relevantes para un proyecto analítico y usar las herramientas de integración, limpieza, validación y análisis de las mismas.

Para resolver la actividad se integrará un informe donde esten unificados los conceptos teoricos, objetivos y resolución con código R.

El dataset usado se puede encontrar siguiendo el [enlace](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016).

### 1.2 Objetivos de la actividad
Los objetivos que queremos cumplir mediante el desarrollo de esta actividad son los siguientes:

+ Aplicar conocimientos adquiridos en un ambito multidisciplinar en un entorno poco conocido
+ Identificar datos relevantes y tratamientos necesarios
+ Analizar los datos adecuadamente
+ Identificar la mejor representación de los resultados para aportar conclusiones sobre el problema planteado
+ Desarrollar las habilidades aprendidas
+ Desarrollar la capacidad de búsqueda, gestión y uso de la información en el ámbito de la ciencia de datos


Para ello desarrollaremos con un caso práctico las seis etapas de un proyecto analítico en ciencia de datos, *identificar el problema*, *recopilar y almacenar datos* relacionados, *limpiar los datos*, *analizar*, *representar* y *responderemos a la pregunta planteada*.

### 1.3 Competencias
Así, las competencias del Máster en Data Science que se desarrollan son: 
+ Capacidad de analizar un problema en el nivel de abstracción adecuado a cada situación y aplicar las habilidades y conocimientos adquiridos para abordarlo y resolverlo. 
+ Capacidad para aplicar las técnicas especíﬁcas de tratamiento de datos (integración, transformación, limpieza y validación) para su posterior análisis.

## 2. Resolución
### 2.1 Identificar el probla y objetivos del análisis
Los suicidios son uno de los principales problemas de la sanidad pública presente en todos los países del mundo independientemente de su nivel económico, población o ubicación geográfica. Con este estudio pretendemos desevelar que sectores de la población están más en riesgo considerando su *edad*, *sexo*, *renta per capita* y *continente* usando la información de distintos países a lo largo de los años.

La finalidad del análisis es generar un informe sobre el risgo de cada grupo de población con el fin de ayudar a enfocar futuros proyectos a identificar las causas del suicidio en los grupos más desfavorecidos

Para ello mostraremos y compararemos los distintos grupos de población en base a:
  + Su generación
  + Su sexo
  + Su grupo de edades
  + Su gdb_per_capita
  + Su continente

Además crearemos un modelo regresivo con los objetivos de:
  + Predecir la tasa de suicidios de un país en los próximos años
  + Completar los datos de HDI for year
  
Y para finalizar buscaremos y compararemos países parecidos pero con tasas de suicidios muy dispares e intentaremos identificar las causas de este comportamiento si es que existen.

### 2.2 Descripción del dataset
El siguiente dataset se ha construido a partir de distintos conjuntos de datos (referencias en la bibliografia) para su análisis. Se compone de 27820 registros con 12 campos. Los registros están almacenados en un fichero CSV llamado *suicides* extaído de la web *Kaggle*.

Estos son los campos que contiene:

+ **country**: Nombre del país
+ **year**: Año del registro
+ **sex**: Genero de la población 
+ **age**: Grupo de edad de la población del país ese año
+ **suicides_no**: Número de suicidios en el país ese año
+ **population**: Habitantes del país ese año
+ **suicides/100k pop** Numero de suicidios de la población por cada cien mil habitantes
+ **country-year**: Identificador compuesto por los campos país y año
+ **HDI for year**: (*Human Development Index*), es un indicador del desarrollo humano en base a la salud, la educación y la riqueza. El valor va de 0 a 1 siendo cuan más alto mejor.
+ **gdp_for_year ($)**: (*Gross domestic product*) (PIB), expresa el valor monetario de la producción de bienes y servicios de un país
+ **gdp_per_capita ($)**: relación entre el GDP y la cantidad de población de un país
+ **generation**: Nombre de la generación a la que pertenece un grupo de población

### 2.3 Preparación de los datos
Instalamos las librerias que necesitaremos durante el desarrollo:
```{r}
#Preparación del análisis
#install.packages("countrycode") ##Es necesario instalar el package para poder ejecutar el código
library(readr)
library(countrycode)

library(plyr)
library(dplyr)

```

El primer paso de nuestro analisis es realizar la lectura del fichero en formato CSV **suicide.csv** en el que se encuentran nuestros datos. El resultado devuelto devuelto por la función *read.csv* será un objeto *data.frame*:
```{r}
#Lectura de datos
dfSuicidios <- read.csv("suicide.csv", encoding = "UTF-8", header = TRUE);
colnames(dfSuicidios)[colnames(dfSuicidios)=="X.U.FEFF.country"] <- "country"
```

Analicemos el dataset para conocer que tipo de información contiene y como está distribuída:
```{r}
#Informe de los datos
summary(dfSuicidios)
```

Una rápida inspección no permite ver que algunas de las columnas del dataset no son necesarias pues son el resultado de una operación entre otras columnas, tenemos **Country-year**, **suicides/100k pop** y **gdp_per_capita**.

Los casos de *suicides/100k pop* y *gdp_per_capita* son interesantes pues presentan una mediacion de los suicidios y el nivel de via mejor para realizar comparaciones ya que hay países con valores de población muy dispares (max: 43805214, min: 278) y lo mismo con el valor del PIB (max: 1.812e+13, min: 4.692e+07)

Por eso eliminaremos las columnas: Country-year, suicides_no y gdp_for_year ($).

Y trabajaremos con las columnas: *country*, *year*, *sex*, *age*, *suicides_100k_pop*, *HDI_for_year*, *gdp_per_capita_USDollar* y *generation* y agregaremos la columna *continent* para ubicar los distintos países en zonas geográficas.

Analicemos cada una de estas variables:
+ **Country**
```{r}
#Informe de country
summary(dfSuicidios$country)
```

+ **Year**
```{r}
#Informe de country
summary(dfSuicidios$year)
```

+ **Sex**
```{r}
#Informe de country
summary(dfSuicidios$sex)
```

+ **Age**
```{r}
#Informe de country
summary(dfSuicidios$age)
```

+ **suicides_100k_pop**
```{r}
#Informe de country
summary(dfSuicidios$suicides.100k.pop)
```

+ **HDI_for_year**
```{r}
#Informe de country
summary(dfSuicidios$HDI.for.year)
```

+ **gdp_per_capita_USDollar**
```{r}
#Informe de country
summary(dfSuicidios$gdp_per_capita....)
```

El campo HDI_for_year requiere un tratamiento especial pues contiene Na's, lo que haremos será completar este dato estimando la media entre los dos valores más cercanos (uno de años anteriores y otro de años posteriores).

### 2.4 Limpieza de los datos

El primer paso será crear la nueva columna **continent** mediante el campo *country* y usando la libreria *countrycode*:
```{r}
dfSuicidios$continent <- countrycode(sourcevar = dfSuicidios[, "country"], origin = "country.name", destination = "continent")
```


Renombrarmos las columnas con espacios y simbolos para que sean más fáciles de manejar:
```{r}
colnames(dfSuicidios)[colnames(dfSuicidios)=="gdp_per_capita...."] <- "gdp_per_capita_USDollar"
colnames(dfSuicidios)[colnames(dfSuicidios)=="gdp_for_year...."] <- "gdp_for_year_USDollar"
colnames(dfSuicidios)[colnames(dfSuicidios)=="HDI.for.year"] <- "HDI_for_year"
colnames(dfSuicidios)[colnames(dfSuicidios)=="country.year"] <- "country_year"
colnames(dfSuicidios)[colnames(dfSuicidios)=="suicides.100k.pop"] <- "suicides_100k_pop"
```

Y nos quedamos con las columnas deseadas:
```{r}
keeps <- c("country","continent", "year","sex","age","suicides_100k_pop","HDI_for_year","gdp_per_capita_USDollar","generation")
dfSuicidiosFiltered <- dfSuicidios[keeps]
```


**Mover esta función a un fichero de funciones**
```{r}
completeHDI_For_YearDatoPosteriorMedia <- function(df){
		j <- 0;
		country <- "";
		vectorNA = c();
		lastValue <- NA
			
		for(i in 1:nrow(df)) {
			
			if(i> 1 && (df[i-1,]$country !=df[i,]$country)) {
				j <- 0;
				vectorNA = c();
				lastValue <- NA
			}

			
			if(is.na(df[i,]$HDI_for_year)) {
				vectorNA <- c(vectorNA,i);
				j <- j+1;
			} else {

				if(is.na(lastValue)) {
					lastValue <-df[i,]$HDI_for_year
				}
				
				if(length(vectorNA)>0) {
					for(value in vectorNA) {
						hdi <- df[i,]$HDI_for_year
						if(!is.na(lastValue)) {
							hdi = (lastValue + df[i,]$HDI_for_year)/2
							
						}

						df[value,]$HDI_for_year <- hdi;
						vectorNA = c();
						
						j<-0;
					}
					lastValue <- df[i,]$HDI_for_year
				}
			}
		}
		return (df);
		
	}
```

Completamos los datos de *HDI_For_Year*
```{r}
dfSuicidiosFiltered <- completeHDI_For_YearDatoPosteriorMedia(dfSuicidiosFiltered)
```

Agrupamos los países en periodos de 5 años para poder compararlos mejor **AÑADIR EXPLICACIÓN ARRIBA**
```{r}
dfSuicidiosFiltered$yearRange5Years<-cut(dfSuicidiosFiltered$year, c(1980,1985,1990,1995,2000,2005,2010,2015,2020))

# Muestra medias de suicidios, gdp, hdi agrupoado por country, continent, yearRange5Years. Si se quiere agrupar por continente nada más, se deja solo continente
dfSuicidiosFiltered2 <- ddply(dfSuicidiosFiltered, .(country, continent,yearRange5Years), summarize,  mean_suicides_100k_pop=mean(suicides_100k_pop), mean_HDI_for_year=mean(HDI_for_year), mean_gdp_per_capita_USDollar=mean(gdp_per_capita_USDollar))
```

### 2.5 Análisis de los datos
### 2.6 Pruebas estadísticas
### 2.7 Representación visual
### 2.8 Conclusiones

## 3. Recursos

*Dataset*  
https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016

*References*  
United Nations Development Program. (2018). Human development index (HDI). Retrieved from http://hdr.undp.org/en/indicators/137506

*World Bank. (2018). World development indicators: GDP (current US$) by country:1985 to 2016. Retrieved from*   http://databank.worldbank.org/data/source/world-development-indicators#

*[Szamil]. (2017). Suicide in the Twenty-First Century [dataset]. Retrieved from*   https://www.kaggle.com/szamil/suicide-in-the-twenty-first-century/notebook

*World Health Organization. (2018). Suicide prevention. Retrieved from*  
http://www.who.int/mental_health/suicide-prevention/en/

*Referencia de informe*  
Gutierrez_teguayco_Practica_2__Limpieza_y_validacion_de__27_12_2017_07_31_05

*Human Development Index (HDI)*  
https://en.wikipedia.org/wiki/Human_Development_Index

*Gross domestic product (GDP)*  
https://en.wikipedia.org/wiki/Gross_domestic_product

*Package ‘countrycode’*
https://cran.r-project.org/web/packages/countrycode/countrycode.pdf


